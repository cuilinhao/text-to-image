<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>APICoreé›†æˆæµ‹è¯•</title>
    <style>
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .control-group {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #f9f9f9;
        }
        .control-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
        }
        button {
            padding: 10px 20px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
        }
        button.secondary {
            background-color: #52c41a;
        }
        .button-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .debug {
            margin-top: 20px;
            padding: 15px;
            background-color: #1e1e1e;
            color: #f0f0f0;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .result {
            margin-top: 20px;
        }
        .image-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: white;
            margin-bottom: 15px;
        }
        .image-item img {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 4px;
        }
        .success-notice {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— APICoreé›†æˆæµ‹è¯•</h1>
        
        <div class="success-notice">
            <h4 style="margin: 0 0 10px 0; color: #52c41a;">ğŸ¯ APICoreå¹³å°ç‰¹æ€§</h4>
            <ul style="margin: 0; padding-left: 20px;">
                <li><strong>æ¨¡å‹</strong>ï¼šsora_image (ä¸äº‘é›¾APIç›¸åŒæ¨¡å‹)</li>
                <li><strong>ç«¯ç‚¹</strong>ï¼šhttps://api.apicore.ai/v1/images/generations</li>
                <li><strong>æ ¼å¼</strong>ï¼šæ ‡å‡†OpenAI Images APIæ ¼å¼</li>
                <li><strong>æ”¯æŒå‚æ•°</strong>ï¼šsize, quality, response_format, n</li>
                <li><strong>ä½œä¸ºå¤‡ç”¨å¹³å°</strong>ï¼šå½“äº‘é›¾APIä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢</li>
            </ul>
        </div>
        
        <div class="control-group">
            <h3>ğŸ”‘ APICoreé…ç½®</h3>
            
            <div class="input-group">
                <label for="apicoreApiKey">APICore API Key:</label>
                <div class="button-group">
                    <input type="password" id="apicoreApiKey" placeholder="è¾“å…¥ä½ çš„APICore API Key" value="" style="flex: 1;">
                    <button onclick="testConnection()" id="testBtn">æµ‹è¯•è¿æ¥</button>
                </div>
            </div>
            
            <div class="input-group">
                <label for="imageSize">å›¾ç‰‡å°ºå¯¸:</label>
                <select id="imageSize">
                    <option value="256x256">256x256</option>
                    <option value="512x512">512x512</option>
                    <option value="1024x1024" selected>1024x1024</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="imageQuality">å›¾ç‰‡è´¨é‡:</label>
                <select id="imageQuality">
                    <option value="standard">æ ‡å‡†</option>
                    <option value="hd" selected>é«˜æ¸…</option>
                </select>
            </div>
        </div>
        
        <div class="control-group">
            <h3>ğŸ¨ å›¾ç‰‡ç”Ÿæˆæµ‹è¯•</h3>
            
            <div class="input-group">
                <label for="promptText">æç¤ºè¯:</label>
                <textarea id="promptText" placeholder="è¾“å…¥å›¾ç‰‡ç”Ÿæˆæç¤ºè¯...">ä¸€ä¸ªå¯çˆ±çš„å’–å•¡æ¯å¤´å®å®ï¼Œç©¿ç€ç²‰è‰²èŠ­è•¾èˆè£™ï¼Œåœ¨é˜³å…‰æ˜åªšçš„å…¬å›­é‡Œå¼€å¿ƒåœ°è·³èˆã€‚ä¸­æ™¯ï¼Œæ­£é¢è§†è§’ï¼Œç”µå½±åœºæ™¯ï¼Œå†™å®é£æ ¼ï¼Œé«˜æ¸…ç”»è´¨ï¼Œç»†èŠ‚æ¸…æ™°ï¼Œå…‰çº¿å……è¶³ï¼Œ3Dæ¸²æŸ“ã€‚ratio 9:16</textarea>
            </div>
            
            <div class="button-group">
                <button onclick="generateImage()" id="generateBtn" class="secondary">ç”Ÿæˆå›¾ç‰‡</button>
                <button onclick="clearLog()" style="background-color: #ff4d4f;">æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>
        
        <div class="result" id="result"></div>
        
        <div style="margin-top: 20px;">
            <h3 style="color: #333;">ğŸ” è°ƒè¯•æ—¥å¿—</h3>
            <div class="debug" id="debug">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è¡¥ä¸ -->
    <script src="src/patches/apicore-integration.js"></script>
    
    <script>
        // å¢å¼ºçš„fetchå‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        async function enhancedFetch(url, options = {}) {
            const maxRetries = 3;
            const retryDelay = 2000;
            
            const defaultOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'User-Agent': 'Sora-Image-Demo/1.0',
                    ...options.headers
                },
                signal: AbortSignal.timeout(60000),
                ...options
            };
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`ğŸ”„ å°è¯•ç¬¬ ${attempt} æ¬¡è¯·æ±‚: ${url}`);
                    
                    const response = await fetch(url, defaultOptions);
                    
                    if (response.ok || (response.status >= 400 && response.status < 500)) {
                        return response;
                    }
                    
                    if (response.status >= 500 && attempt < maxRetries) {
                        console.log(`âš ï¸ æœåŠ¡å™¨é”™è¯¯ (${response.status})ï¼Œ${retryDelay/1000}ç§’åé‡è¯•...`);
                        await new Promise(resolve => setTimeout(resolve, retryDelay));
                        continue;
                    }
                    
                    return response;
                    
                } catch (error) {
                    console.log(`âŒ è¯·æ±‚å¼‚å¸¸ (å°è¯• ${attempt}/${maxRetries}): ${error.message}`);
                    
                    if (attempt === maxRetries) {
                        throw new Error(`è¯·æ±‚å¤±è´¥ (${maxRetries}æ¬¡å°è¯•): ${error.message}`);
                    }
                    
                    console.log(`â³ ${retryDelay/1000}ç§’åé‡è¯•...`);
                    await new Promise(resolve => setTimeout(resolve, retryDelay));
                }
            }
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            const apiKey = document.getElementById('apicoreApiKey').value;
            const testBtn = document.getElementById('testBtn');
            const debug = document.getElementById('debug');
            
            if (!apiKey) {
                alert('è¯·è¾“å…¥APICore API Key');
                return;
            }
            
            testBtn.disabled = true;
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            debug.textContent += '\n\nğŸ” å¼€å§‹æµ‹è¯•APICoreè¿æ¥...\n';
            
            try {
                const result = await callAPICore('æµ‹è¯•å›¾ç‰‡ç”Ÿæˆ', apiKey, {
                    size: "512x512",
                    n: 1
                });
                
                debug.textContent += `âœ… APICoreè¿æ¥æµ‹è¯•æˆåŠŸ!\n`;
                debug.textContent += `ğŸ¢ å¹³å°: ${result.platform}\n`;
                debug.textContent += `ğŸ¤– æ¨¡å‹: ${result.model}\n`;
                debug.textContent += `ğŸ–¼ï¸ æµ‹è¯•å›¾ç‰‡: ${result.imageUrl}\n`;
                
                alert('âœ… APICoreè¿æ¥æµ‹è¯•æˆåŠŸ!\n\n' + 
                      `å¹³å°: ${result.platform}\n` +
                      `æ¨¡å‹: ${result.model}\n` +
                      `å›¾ç‰‡å·²ç”Ÿæˆ: ${result.imageUrl.substring(0, 50)}...`);
                      
            } catch (error) {
                debug.textContent += `âŒ APICoreè¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}\n`;
                alert('âŒ APICoreè¿æ¥æµ‹è¯•å¤±è´¥:\n\n' + error.message);
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'æµ‹è¯•è¿æ¥';
            }
        }
        
        // ç”Ÿæˆå›¾ç‰‡
        async function generateImage() {
            const apiKey = document.getElementById('apicoreApiKey').value;
            const promptText = document.getElementById('promptText').value;
            const imageSize = document.getElementById('imageSize').value;
            const imageQuality = document.getElementById('imageQuality').value;
            const generateBtn = document.getElementById('generateBtn');
            const result = document.getElementById('result');
            const debug = document.getElementById('debug');
            
            if (!apiKey || !promptText) {
                alert('è¯·è¾“å…¥API Keyå’Œæç¤ºè¯');
                return;
            }
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                debug.textContent += '\n\nğŸš€ å¼€å§‹ç”Ÿæˆå›¾ç‰‡...\n';
                
                const imageResult = await callAPICore(promptText, apiKey, {
                    size: imageSize,
                    quality: imageQuality,
                    n: 1
                });
                
                // æ˜¾ç¤ºç»“æœ
                result.innerHTML = `
                    <div class="image-item">
                        <h4>âœ… ç”ŸæˆæˆåŠŸ</h4>
                        <p><strong>å¹³å°:</strong> ${imageResult.platform}</p>
                        <p><strong>æ¨¡å‹:</strong> ${imageResult.model}</p>
                        <p><strong>å°ºå¯¸:</strong> ${imageSize}</p>
                        <p><strong>è´¨é‡:</strong> ${imageQuality}</p>
                        <p><strong>æç¤ºè¯:</strong> ${promptText.substring(0, 100)}...</p>
                        <img src="${imageResult.imageUrl}" alt="Generated Image" onload="console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ')" onerror="console.log('å›¾ç‰‡åŠ è½½å¤±è´¥')">
                        <div style="margin-top: 10px;">
                            <button onclick="downloadImage('${imageResult.imageUrl}')" style="background-color: #52c41a;">ä¸‹è½½å›¾ç‰‡</button>
                            <button onclick="copyUrl('${imageResult.imageUrl}')" style="background-color: #1890ff; margin-left: 10px;">å¤åˆ¶é“¾æ¥</button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                result.innerHTML = `
                    <div class="image-item" style="border-color: #ff4d4f;">
                        <h4 style="color: #ff4d4f;">âŒ ç”Ÿæˆå¤±è´¥</h4>
                        <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}</p>
                        <div style="margin-top: 10px; padding: 10px; background-color: #fff2f0; border-radius: 4px;">
                            <h5 style="margin: 0 0 5px 0;">ğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:</h5>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>æ£€æŸ¥APICore API Keyæ˜¯å¦æ­£ç¡®</li>
                                <li>ç¡®è®¤è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³</li>
                                <li>æ£€æŸ¥æç¤ºè¯æ˜¯å¦åŒ…å«æ•æ„Ÿå†…å®¹</li>
                                <li>ç¨åé‡è¯•ï¼ˆå¯èƒ½æ˜¯ä¸´æ—¶æœåŠ¡é—®é¢˜ï¼‰</li>
                            </ul>
                        </div>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'ç”Ÿæˆå›¾ç‰‡';
            }
        }
        
        // ä¸‹è½½å›¾ç‰‡
        function downloadImage(url) {
            const link = document.createElement('a');
            link.href = url;
            link.download = `apicore-generated-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // å¤åˆ¶é“¾æ¥
        function copyUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('å›¾ç‰‡é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
            });
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('debug').textContent = 'æ—¥å¿—å·²æ¸…ç©ºï¼Œç­‰å¾…æ–°çš„æ“ä½œ...';
        }
    </script>
</body>
</html>