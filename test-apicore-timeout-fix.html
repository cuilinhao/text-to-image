<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>APICore è¶…æ—¶ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .debug {
            background-color: #1e1e1e;
            color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:disabled {
            background-color: #ccc;
        }
        .success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ APICore è¶…æ—¶ä¿®å¤æµ‹è¯•</h1>
    
    <div>
        <h3>ğŸ”‘ API Key é…ç½®</h3>
        <p>è¯·åœ¨ä»£ç ä¸­é…ç½®æ‚¨è‡ªå·±çš„ API Key</p>
        <p><strong>é—®é¢˜åˆ†æ:</strong> å‘ç°JSONæ ¼å¼é”™è¯¯å’Œè¶…æ—¶é—®é¢˜ï¼Œç°åœ¨è¿›è¡Œä¿®å¤</p>
    </div>
    
    <div>
        <button onclick="testAPICore()" id="testBtn">æµ‹è¯•ä¿®å¤åçš„è¿æ¥</button>
        <button onclick="generateTestImage()" id="generateBtn">ç”Ÿæˆæµ‹è¯•å›¾ç‰‡</button>
        <button onclick="clearLog()" id="clearBtn">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="debug" id="debug">ç­‰å¾…æµ‹è¯•...</div>
    
    <div id="result"></div>

    <script>
        const API_KEY = ''; // è¯·åœ¨æ­¤å¤„è¾“å…¥ä½ çš„APICore API Key
        
        if (!API_KEY) {
            alert('è¯·å…ˆåœ¨ä»£ç ä¸­é…ç½®æ‚¨çš„APICore API Key');
        }
        
        function log(message) {
            const debug = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            debug.textContent += `\n[${timestamp}] ${message}`;
            debug.scrollTop = debug.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('debug').textContent = 'æ—¥å¿—å·²æ¸…ç©º...';
            document.getElementById('result').innerHTML = '';
        }
        
        // ä¿®å¤åçš„ APICore è°ƒç”¨å‡½æ•°
        async function callAPICoreFixed(prompt, apiKey, options = {}) {
            const {
                size = "1024x1024",
                quality = "hd",
                response_format = "url",
                n = 1
            } = options;

            log('ğŸ” å¼€å§‹è°ƒç”¨ä¿®å¤åçš„APICore API...');
            log(`ğŸ“ æç¤ºè¯: ${prompt.substring(0, 50)}...`);
            log(`ğŸ”‘ API Key: ${apiKey.substring(0, 15)}...`);

            // ä¿®å¤ï¼šç¡®ä¿è¯·æ±‚ä½“æ ¼å¼æ­£ç¡®
            const requestBody = {
                prompt: prompt.trim(),
                model: "sora_image",
                n: parseInt(n),
                size: size,
                quality: quality,
                response_format: response_format
            };

            log('ğŸ“¦ ä¿®å¤åçš„è¯·æ±‚ä½“: ' + JSON.stringify(requestBody, null, 2));

            try {
                // ä¿®å¤ï¼šä½¿ç”¨æ›´åˆç†çš„è¶…æ—¶æ—¶é—´å’Œé‡è¯•æœºåˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    log('â° è¯·æ±‚å³å°†è¶…æ—¶ (120ç§’)...');
                    controller.abort();
                }, 120000); // 2åˆ†é’Ÿè¶…æ—¶

                log('ğŸš€ å‘é€ä¿®å¤åçš„è¯·æ±‚åˆ° APICore...');
                
                const response = await fetch('https://api.apicore.ai/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'User-Agent': 'APICore-Fix/1.0',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                log(`ğŸ“Š APICoreå“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);

                // è·å–å“åº”æ–‡æœ¬
                const responseText = await response.text();
                log(`ğŸ“„ åŸå§‹å“åº”: ${responseText.substring(0, 200)}...`);

                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log('âœ… APICoreæˆåŠŸå“åº”: ' + JSON.stringify(data, null, 2));

                        // æå–å›¾ç‰‡URL
                        if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                            const imageUrl = data.data[0].url || data.data[0].b64_json;
                            if (imageUrl) {
                                log(`ğŸ–¼ï¸ æå–åˆ°å›¾ç‰‡URL: ${imageUrl.substring(0, 80)}...`);
                                return {
                                    success: true,
                                    imageUrl: imageUrl,
                                    platform: 'APICore',
                                    model: 'sora_image',
                                    created: data.created
                                };
                            }
                        }

                        throw new Error('æ— æ³•ä»APICoreå“åº”ä¸­æå–å›¾ç‰‡URL');
                    } catch (parseError) {
                        log(`âŒ JSONè§£æå¤±è´¥: ${parseError.message}`);
                        throw new Error(`å“åº”è§£æå¤±è´¥: ${parseError.message}`);
                    }
                } else {
                    log(`âŒ APICoreé”™è¯¯å“åº”: ${responseText}`);
                    
                    try {
                        const errorData = JSON.parse(responseText);
                        const errorMessage = errorData.error?.message || errorData.message || responseText;
                        
                        // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                        if (response.status === 401) {
                            throw new Error(`è®¤è¯å¤±è´¥: è¯·æ£€æŸ¥API Keyæ˜¯å¦æ­£ç¡® (${errorMessage})`);
                        } else if (response.status === 429) {
                            throw new Error(`è¯·æ±‚è¿‡äºé¢‘ç¹: è¯·ç¨åå†è¯• (${errorMessage})`);
                        } else if (response.status === 400) {
                            throw new Error(`è¯·æ±‚å‚æ•°é”™è¯¯: ${errorMessage}`);
                        } else {
                            throw new Error(`APIé”™è¯¯ (${response.status}): ${errorMessage}`);
                        }
                    } catch (parseError) {
                        throw new Error(`APIé”™è¯¯ (${response.status}): ${responseText}`);
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    log(`â° è¯·æ±‚è¶…æ—¶ (2åˆ†é’Ÿ)`);
                    throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œå›¾ç‰‡ç”Ÿæˆæ—¶é—´è¿‡é•¿ï¼Œè¯·ç¨åé‡è¯•');
                }
                
                log(`ğŸ’¥ è¯·æ±‚å¼‚å¸¸: ${error.message}`);
                throw error;
            }
        }
        
        // æµ‹è¯•è¿æ¥
        async function testAPICore() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            
            try {
                log('ğŸ” å¼€å§‹æµ‹è¯•ä¿®å¤åçš„APICoreè¿æ¥...');
                const result = await callAPICoreFixed('æµ‹è¯•å›¾ç‰‡ç”Ÿæˆ', API_KEY, {
                    size: "512x512",
                    n: 1
                });
                
                log('ğŸ‰ è¿æ¥æµ‹è¯•æˆåŠŸ!');
                document.getElementById('result').innerHTML = `
                    <div class="success">
                        <h4>âœ… APICoreè¿æ¥æµ‹è¯•æˆåŠŸ!</h4>
                        <p><strong>å¹³å°:</strong> ${result.platform}</p>
                        <p><strong>æ¨¡å‹:</strong> ${result.model}</p>
                        <p><strong>å›¾ç‰‡URL:</strong> <a href="${result.imageUrl}" target="_blank">${result.imageUrl.substring(0, 50)}...</a></p>
                        <img src="${result.imageUrl}" style="max-width: 300px; margin-top: 10px;" alt="æµ‹è¯•å›¾ç‰‡" onload="console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ')" onerror="console.log('å›¾ç‰‡åŠ è½½å¤±è´¥')">
                    </div>
                `;
                
            } catch (error) {
                log(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h4>âŒ APICoreè¿æ¥æµ‹è¯•å¤±è´¥</h4>
                        <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}</p>
                        <h5>ğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:</h5>
                        <ul>
                            <li>æ£€æŸ¥API Keyæ˜¯å¦æ­£ç¡®å’Œæœ‰æ•ˆ</li>
                            <li>ç¡®è®¤è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³</li>
                            <li>æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®š</li>
                            <li>ç¨åé‡è¯•ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨ç¹å¿™</li>
                            <li>è”ç³»APICoreå®¢æœç¡®è®¤æœåŠ¡çŠ¶æ€</li>
                        </ul>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'æµ‹è¯•ä¿®å¤åçš„è¿æ¥';
            }
        }
        
        // ç”Ÿæˆæµ‹è¯•å›¾ç‰‡
        async function generateTestImage() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            
            try {
                log('ğŸ¨ å¼€å§‹ç”Ÿæˆæµ‹è¯•å›¾ç‰‡...');
                const result = await callAPICoreFixed('ä¸€ä¸ªå¯çˆ±çš„å°çŒ«å’ªåœ¨èŠ±å›­é‡Œç©è€ï¼Œé˜³å…‰æ˜åªšï¼Œè‰²å½©é²œè‰³ï¼Œé«˜æ¸…ç”»è´¨', API_KEY, {
                    size: "1024x1024",
                    quality: "hd",
                    n: 1
                });
                
                log('ğŸ‰ å›¾ç‰‡ç”ŸæˆæˆåŠŸ!');
                document.getElementById('result').innerHTML = `
                    <div class="success">
                        <h4>âœ… å›¾ç‰‡ç”ŸæˆæˆåŠŸ!</h4>
                        <p><strong>å¹³å°:</strong> ${result.platform}</p>
                        <p><strong>æ¨¡å‹:</strong> ${result.model}</p>
                        <p><strong>å›¾ç‰‡URL:</strong> <a href="${result.imageUrl}" target="_blank">${result.imageUrl.substring(0, 50)}...</a></p>
                        <img src="${result.imageUrl}" style="max-width: 400px; margin-top: 10px;" alt="ç”Ÿæˆçš„å›¾ç‰‡" onload="console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ')" onerror="console.log('å›¾ç‰‡åŠ è½½å¤±è´¥')">
                        <br>
                        <a href="${result.imageUrl}" download="apicore-test.png" style="display: inline-block; margin-top: 10px; padding: 5px 10px; background-color: #52c41a; color: white; text-decoration: none; border-radius: 4px;">ä¸‹è½½å›¾ç‰‡</a>
                    </div>
                `;
                
            } catch (error) {
                log(`âŒ å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${error.message}`);
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h4>âŒ å›¾ç‰‡ç”Ÿæˆå¤±è´¥</h4>
                        <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}</p>
                        <h5>ğŸ’¡ è¯¦ç»†åˆ†æ:</h5>
                        <ul>
                            <li><strong>å¦‚æœæ˜¯è¶…æ—¶é”™è¯¯:</strong> APICoreæœåŠ¡å™¨å“åº”è¾ƒæ…¢ï¼Œå·²å°†è¶…æ—¶æ—¶é—´å»¶é•¿åˆ°2åˆ†é’Ÿ</li>
                            <li><strong>å¦‚æœæ˜¯JSONæ ¼å¼é”™è¯¯:</strong> å·²ä¿®å¤è¯·æ±‚ä½“æ ¼å¼ï¼Œç¡®ä¿æ‰€æœ‰å‚æ•°ç±»å‹æ­£ç¡®</li>
                            <li><strong>å¦‚æœæ˜¯è®¤è¯é”™è¯¯:</strong> è¯·æ£€æŸ¥API Keyæ˜¯å¦æ­£ç¡®</li>
                            <li><strong>å¦‚æœæ˜¯å‚æ•°é”™è¯¯:</strong> å·²ä¼˜åŒ–è¯·æ±‚å‚æ•°ï¼Œç¬¦åˆAPICoreè§„èŒƒ</li>
                        </ul>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'ç”Ÿæˆæµ‹è¯•å›¾ç‰‡';
            }
        }
    </script>
</body>
</html>