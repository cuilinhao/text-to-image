<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>APICore 超时修复测试</title>
    <style>
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .debug {
            background-color: #1e1e1e;
            color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:disabled {
            background-color: #ccc;
        }
        .success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔧 APICore 超时修复测试</h1>
    
    <div>
        <h3>🔑 API Key 配置</h3>
        <p>请在代码中配置您自己的 API Key</p>
        <p><strong>问题分析:</strong> 发现JSON格式错误和超时问题，现在进行修复</p>
    </div>
    
    <div>
        <button onclick="testAPICore()" id="testBtn">测试修复后的连接</button>
        <button onclick="generateTestImage()" id="generateBtn">生成测试图片</button>
        <button onclick="clearLog()" id="clearBtn">清空日志</button>
    </div>
    
    <div class="debug" id="debug">等待测试...</div>
    
    <div id="result"></div>

    <script>
        const API_KEY = ''; // 请在此处输入你的APICore API Key
        
        if (!API_KEY) {
            alert('请先在代码中配置您的APICore API Key');
        }
        
        function log(message) {
            const debug = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            debug.textContent += `\n[${timestamp}] ${message}`;
            debug.scrollTop = debug.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('debug').textContent = '日志已清空...';
            document.getElementById('result').innerHTML = '';
        }
        
        // 修复后的 APICore 调用函数
        async function callAPICoreFixed(prompt, apiKey, options = {}) {
            const {
                size = "1024x1024",
                quality = "hd",
                response_format = "url",
                n = 1
            } = options;

            log('🔍 开始调用修复后的APICore API...');
            log(`📝 提示词: ${prompt.substring(0, 50)}...`);
            log(`🔑 API Key: ${apiKey.substring(0, 15)}...`);

            // 修复：确保请求体格式正确
            const requestBody = {
                prompt: prompt.trim(),
                model: "sora_image",
                n: parseInt(n),
                size: size,
                quality: quality,
                response_format: response_format
            };

            log('📦 修复后的请求体: ' + JSON.stringify(requestBody, null, 2));

            try {
                // 修复：使用更合理的超时时间和重试机制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    log('⏰ 请求即将超时 (120秒)...');
                    controller.abort();
                }, 120000); // 2分钟超时

                log('🚀 发送修复后的请求到 APICore...');
                
                const response = await fetch('https://api.apicore.ai/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'User-Agent': 'APICore-Fix/1.0',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                log(`📊 APICore响应状态: ${response.status} ${response.statusText}`);

                // 获取响应文本
                const responseText = await response.text();
                log(`📄 原始响应: ${responseText.substring(0, 200)}...`);

                if (response.ok) {
                    try {
                        const data = JSON.parse(responseText);
                        log('✅ APICore成功响应: ' + JSON.stringify(data, null, 2));

                        // 提取图片URL
                        if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                            const imageUrl = data.data[0].url || data.data[0].b64_json;
                            if (imageUrl) {
                                log(`🖼️ 提取到图片URL: ${imageUrl.substring(0, 80)}...`);
                                return {
                                    success: true,
                                    imageUrl: imageUrl,
                                    platform: 'APICore',
                                    model: 'sora_image',
                                    created: data.created
                                };
                            }
                        }

                        throw new Error('无法从APICore响应中提取图片URL');
                    } catch (parseError) {
                        log(`❌ JSON解析失败: ${parseError.message}`);
                        throw new Error(`响应解析失败: ${parseError.message}`);
                    }
                } else {
                    log(`❌ APICore错误响应: ${responseText}`);
                    
                    try {
                        const errorData = JSON.parse(responseText);
                        const errorMessage = errorData.error?.message || errorData.message || responseText;
                        
                        // 提供更详细的错误信息
                        if (response.status === 401) {
                            throw new Error(`认证失败: 请检查API Key是否正确 (${errorMessage})`);
                        } else if (response.status === 429) {
                            throw new Error(`请求过于频繁: 请稍后再试 (${errorMessage})`);
                        } else if (response.status === 400) {
                            throw new Error(`请求参数错误: ${errorMessage}`);
                        } else {
                            throw new Error(`API错误 (${response.status}): ${errorMessage}`);
                        }
                    } catch (parseError) {
                        throw new Error(`API错误 (${response.status}): ${responseText}`);
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    log(`⏰ 请求超时 (2分钟)`);
                    throw new Error('请求超时，图片生成时间过长，请稍后重试');
                }
                
                log(`💥 请求异常: ${error.message}`);
                throw error;
            }
        }
        
        // 测试连接
        async function testAPICore() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = '测试中...';
            
            try {
                log('🔍 开始测试修复后的APICore连接...');
                const result = await callAPICoreFixed('测试图片生成', API_KEY, {
                    size: "512x512",
                    n: 1
                });
                
                log('🎉 连接测试成功!');
                document.getElementById('result').innerHTML = `
                    <div class="success">
                        <h4>✅ APICore连接测试成功!</h4>
                        <p><strong>平台:</strong> ${result.platform}</p>
                        <p><strong>模型:</strong> ${result.model}</p>
                        <p><strong>图片URL:</strong> <a href="${result.imageUrl}" target="_blank">${result.imageUrl.substring(0, 50)}...</a></p>
                        <img src="${result.imageUrl}" style="max-width: 300px; margin-top: 10px;" alt="测试图片" onload="console.log('图片加载成功')" onerror="console.log('图片加载失败')">
                    </div>
                `;
                
            } catch (error) {
                log(`❌ 连接测试失败: ${error.message}`);
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h4>❌ APICore连接测试失败</h4>
                        <p><strong>错误信息:</strong> ${error.message}</p>
                        <h5>💡 可能的解决方案:</h5>
                        <ul>
                            <li>检查API Key是否正确和有效</li>
                            <li>确认账户余额是否充足</li>
                            <li>检查网络连接是否稳定</li>
                            <li>稍后重试，可能是服务器繁忙</li>
                            <li>联系APICore客服确认服务状态</li>
                        </ul>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '测试修复后的连接';
            }
        }
        
        // 生成测试图片
        async function generateTestImage() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = '生成中...';
            
            try {
                log('🎨 开始生成测试图片...');
                const result = await callAPICoreFixed('一个可爱的小猫咪在花园里玩耍，阳光明媚，色彩鲜艳，高清画质', API_KEY, {
                    size: "1024x1024",
                    quality: "hd",
                    n: 1
                });
                
                log('🎉 图片生成成功!');
                document.getElementById('result').innerHTML = `
                    <div class="success">
                        <h4>✅ 图片生成成功!</h4>
                        <p><strong>平台:</strong> ${result.platform}</p>
                        <p><strong>模型:</strong> ${result.model}</p>
                        <p><strong>图片URL:</strong> <a href="${result.imageUrl}" target="_blank">${result.imageUrl.substring(0, 50)}...</a></p>
                        <img src="${result.imageUrl}" style="max-width: 400px; margin-top: 10px;" alt="生成的图片" onload="console.log('图片加载成功')" onerror="console.log('图片加载失败')">
                        <br>
                        <a href="${result.imageUrl}" download="apicore-test.png" style="display: inline-block; margin-top: 10px; padding: 5px 10px; background-color: #52c41a; color: white; text-decoration: none; border-radius: 4px;">下载图片</a>
                    </div>
                `;
                
            } catch (error) {
                log(`❌ 图片生成失败: ${error.message}`);
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h4>❌ 图片生成失败</h4>
                        <p><strong>错误信息:</strong> ${error.message}</p>
                        <h5>💡 详细分析:</h5>
                        <ul>
                            <li><strong>如果是超时错误:</strong> APICore服务器响应较慢，已将超时时间延长到2分钟</li>
                            <li><strong>如果是JSON格式错误:</strong> 已修复请求体格式，确保所有参数类型正确</li>
                            <li><strong>如果是认证错误:</strong> 请检查API Key是否正确</li>
                            <li><strong>如果是参数错误:</strong> 已优化请求参数，符合APICore规范</li>
                        </ul>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '生成测试图片';
            }
        }
    </script>
</body>
</html>