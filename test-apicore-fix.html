<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>APICore 修复测试</title>
    <style>
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .debug {
            background-color: #1e1e1e;
            color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
        }

        button {
            padding: 10px 20px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }

        button:disabled {
            background-color: #ccc;
        }

        .success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>🔧 APICore 修复测试</h1>

    <div>
        <h3>🔑 API Key 配置</h3>
        <p>使用提供的 API Key</p>
    </div>

    <div>
        <button onclick="testAPICore()" id="testBtn">测试 APICore 连接</button>
        <button onclick="generateTestImage()" id="generateBtn">生成测试图片</button>
        <button onclick="clearLog()" id="clearBtn">清空日志</button>
    </div>

    <div class="debug" id="debug">等待测试...</div>

    <div id="result"></div>

    <script>
        const API_KEY = ''; // 请在此处输入你的APICore API Key

        function log(message) {
            const debug = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            debug.textContent += `\n[${timestamp}] ${message}`;
            debug.scrollTop = debug.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debug').textContent = '日志已清空...';
            document.getElementById('result').innerHTML = '';
        }

        // 优化的 APICore 调用函数
        async function callAPICore(prompt, apiKey, options = {}) {
            const {
                size = "1024x1024",
                quality = "hd",
                response_format = "url",
                n = 1
            } = options;

            log('🔍 开始调用APICore API...');
            log(`📝 提示词: ${prompt.substring(0, 50)}...`);
            log(`🔑 API Key: ${apiKey.substring(0, 15)}...`);

            const requestBody = {
                prompt: prompt,
                model: "sora_image",
                n: n,
                size: size,
                quality: quality,
                response_format: response_format
            };

            log('📦 请求体: ' + JSON.stringify(requestBody, null, 2));

            try {
                // 使用更长的超时时间（3分钟）
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    log('⏰ 请求即将超时...');
                    controller.abort();
                }, 180000); // 3分钟超时

                log('🚀 发送请求到 APICore...');
                const response = await fetch('https://api.apicore.ai/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'User-Agent': 'APICore-Test/1.0'
                    },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                log(`📊 APICore响应状态: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const data = await response.json();
                    log('✅ APICore成功响应: ' + JSON.stringify(data, null, 2));

                    // 提取图片URL
                    if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                        const imageUrl = data.data[0].url || data.data[0].b64_json;
                        if (imageUrl) {
                            log(`🖼️ 提取到图片URL: ${imageUrl.substring(0, 80)}...`);
                            return {
                                success: true,
                                imageUrl: imageUrl,
                                platform: 'APICore',
                                model: 'sora_image',
                                created: data.created
                            };
                        }
                    }

                    throw new Error('无法从APICore响应中提取图片URL');
                } else {
                    const errorText = await response.text();
                    log(`❌ APICore错误响应: ${errorText}`);

                    try {
                        const errorData = JSON.parse(errorText);
                        const errorMessage = errorData.error?.message || errorData.message || errorText;

                        // 提供更详细的错误信息
                        if (response.status === 401) {
                            throw new Error(`认证失败: 请检查API Key是否正确 (${errorMessage})`);
                        } else if (response.status === 429) {
                            throw new Error(`请求过于频繁: 请稍后再试 (${errorMessage})`);
                        } else if (response.status === 400) {
                            throw new Error(`请求参数错误: ${errorMessage}`);
                        } else {
                            throw new Error(`API错误 (${response.status}): ${errorMessage}`);
                        }
                    } catch (parseError) {
                        throw new Error(`API错误 (${response.status}): ${errorText}`);
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    log(`⏰ 请求超时 (3分钟)`);
                    throw new Error('请求超时，图片生成时间过长，请稍后重试');
                }

                log(`💥 请求异常: ${error.message}`);
                throw error;
            }
        }

        // 测试连接
        async function testAPICore() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = '测试中...';

            try {
                log('🔍 开始测试APICore连接...');
                const result = await callAPICore('测试图片生成', API_KEY, {
                    size: "512x512",
                    n: 1
                });

                log('🎉 连接测试成功!');
                document.getElementById('result').innerHTML = `
                    <div class="success">
                        <h4>✅ APICore连接测试成功!</h4>
                        <p><strong>平台:</strong> ${result.platform}</p>
                        <p><strong>模型:</strong> ${result.model}</p>
                        <p><strong>图片URL:</strong> <a href="${result.imageUrl}" target="_blank">${result.imageUrl.substring(0, 50)}...</a></p>
                        <img src="${result.imageUrl}" style="max-width: 300px; margin-top: 10px;" alt="测试图片">
                    </div>
                `;

            } catch (error) {
                log(`❌ 连接测试失败: ${error.message}`);
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h4>❌ APICore连接测试失败</h4>
                        <p><strong>错误信息:</strong> ${error.message}</p>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '测试 APICore 连接';
            }
        }

        // 生成测试图片
        async function generateTestImage() {
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = '生成中...';

            try {
                log('🎨 开始生成测试图片...');
                const result = await callAPICore('一个可爱的小猫咪在花园里玩耍，阳光明媚，色彩鲜艳', API_KEY, {
                    size: "1024x1024",
                    quality: "hd",
                    n: 1
                });

                log('🎉 图片生成成功!');
                document.getElementById('result').innerHTML = `
                    <div class="success">
                        <h4>✅ 图片生成成功!</h4>
                        <p><strong>平台:</strong> ${result.platform}</p>
                        <p><strong>模型:</strong> ${result.model}</p>
                        <p><strong>图片URL:</strong> <a href="${result.imageUrl}" target="_blank">${result.imageUrl.substring(0, 50)}...</a></p>
                        <img src="${result.imageUrl}" style="max-width: 400px; margin-top: 10px;" alt="生成的图片">
                        <br>
                        <a href="${result.imageUrl}" download="apicore-test.png" style="display: inline-block; margin-top: 10px; padding: 5px 10px; background-color: #52c41a; color: white; text-decoration: none; border-radius: 4px;">下载图片</a>
                    </div>
                `;

            } catch (error) {
                log(`❌ 图片生成失败: ${error.message}`);
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h4>❌ 图片生成失败</h4>
                        <p><strong>错误信息:</strong> ${error.message}</p>
                        <h5>💡 可能的解决方案:</h5>
                        <ul>
                            <li>检查API Key是否正确</li>
                            <li>确认账户余额是否充足</li>
                            <li>检查网络连接是否正常</li>
                            <li>稍后重试，可能是服务器繁忙</li>
                        </ul>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '生成测试图片';
            }
        }
    </script>
</body>

</html>